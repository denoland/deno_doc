var _globalThis_process;let STEMMERS={arabic:"ar",armenian:"am",bulgarian:"bg",danish:"dk",dutch:"nl",english:"en",finnish:"fi",french:"fr",german:"de",greek:"gr",hungarian:"hu",indian:"in",indonesian:"id",irish:"ie",italian:"it",lithuanian:"lt",nepali:"np",norwegian:"no",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"rs",slovenian:"ru",spanish:"es",swedish:"se",tamil:"ta",turkish:"tr",ukrainian:"uk",sanskrit:"sk"},SPLITTERS={dutch:/[^A-Za-zàèéìòóù0-9_'-]+/gim,english:/[^A-Za-zàèéìòóù0-9_'-]+/gim,french:/[^a-z0-9äâàéèëêïîöôùüûœç-]+/gim,italian:/[^A-Za-zàèéìòóù0-9_'-]+/gim,norwegian:/[^a-z0-9_æøåÆØÅäÄöÖüÜ]+/gim,portuguese:/[^a-z0-9à-úÀ-Ú]/gim,russian:/[^a-z0-9а-яА-ЯёЁ]+/gim,spanish:/[^a-z0-9A-Zá-úÁ-ÚñÑüÜ]+/gim,swedish:/[^a-z0-9_åÅäÄöÖüÜ-]+/gim,german:/[^a-z0-9A-ZäöüÄÖÜß]+/gim,finnish:/[^a-z0-9äöÄÖ]+/gim,danish:/[^a-z0-9æøåÆØÅ]+/gim,hungarian:/[^a-z0-9áéíóöőúüűÁÉÍÓÖŐÚÜŰ]+/gim,romanian:/[^a-z0-9ăâîșțĂÂÎȘȚ]+/gim,serbian:/[^a-z0-9čćžšđČĆŽŠĐ]+/gim,turkish:/[^a-z0-9çÇğĞıİöÖşŞüÜ]+/gim,lithuanian:/[^a-z0-9ąčęėįšųūžĄČĘĖĮŠŲŪŽ]+/gim,arabic:/[^a-z0-9أ-ي]+/gim,nepali:/[^a-z0-9अ-ह]+/gim,irish:/[^a-z0-9áéíóúÁÉÍÓÚ]+/gim,indian:/[^a-z0-9अ-ह]+/gim,armenian:/[^a-z0-9ա-ֆ]+/gim,greek:/[^a-z0-9α-ωά-ώ]+/gim,indonesian:/[^a-z0-9]+/gim,ukrainian:/[^a-z0-9а-яА-ЯіїєІЇЄ]+/gim,slovenian:/[^a-z0-9čžšČŽŠ]+/gim,bulgarian:/[^a-z0-9а-яА-Я]+/gim,tamil:/[^a-z0-9அ-ஹ]+/gim,sanskrit:/[^a-z0-9A-Zāīūṛḷṃṁḥśṣṭḍṇṅñḻḹṝ]+/gim},SUPPORTED_LANGUAGES=Object.keys(STEMMERS),allLanguages=SUPPORTED_LANGUAGES.join("\n - "),baseId=Date.now().toString().slice(5),errors={NO_LANGUAGE_WITH_CUSTOM_TOKENIZER:"Do not pass the language option to create when using a custom tokenizer.",LANGUAGE_NOT_SUPPORTED:`Language "%s" is not supported.
Supported languages are:
 - ${allLanguages}`,INVALID_STEMMER_FUNCTION_TYPE:"config.stemmer property must be a function.",MISSING_STEMMER:'As of version 1.0.0 @orama/orama does not ship non English stemmers by default. To solve this, please explicitly import and specify the "%s" stemmer from the package @orama/stemmers. See https://docs.oramasearch.com/open-source/text-analysis/stemming for more information.',CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY:"Custom stop words array must only contain strings.",UNSUPPORTED_COMPONENT:'Unsupported component "%s".',COMPONENT_MUST_BE_FUNCTION:'The component "%s" must be a function.',COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS:'The component "%s" must be a function or an array of functions.',INVALID_SCHEMA_TYPE:'Unsupported schema type "%s" at "%s". Expected "string", "boolean" or "number" or array of them.',DOCUMENT_ID_MUST_BE_STRING:'Document id must be of type "string". Got "%s" instead.',DOCUMENT_ALREADY_EXISTS:'A document with id "%s" already exists.',DOCUMENT_DOES_NOT_EXIST:'A document with id "%s" does not exists.',MISSING_DOCUMENT_PROPERTY:'Missing searchable property "%s".',INVALID_DOCUMENT_PROPERTY:'Invalid document property "%s": expected "%s", got "%s"',UNKNOWN_INDEX:'Invalid property name "%s". Expected a wildcard string ("*") or array containing one of the following properties: %s',INVALID_BOOST_VALUE:"Boost value must be a number greater than, or less than 0.",INVALID_FILTER_OPERATION:"You can only use one operation per filter, you requested %d.",SCHEMA_VALIDATION_FAILURE:'Cannot insert document due schema validation failure on "%s" property.',INVALID_SORT_SCHEMA_TYPE:'Unsupported sort schema type "%s" at "%s". Expected "string" or "number".',CANNOT_SORT_BY_ARRAY:'Cannot configure sort for "%s" because it is an array (%s).',UNABLE_TO_SORT_ON_UNKNOWN_FIELD:'Unable to sort on unknown field "%s". Allowed fields: %s',SORT_DISABLED:"Sort is disabled. Please read the documentation at https://docs.oramasearch for more information.",UNKNOWN_GROUP_BY_PROPERTY:'Unknown groupBy property "%s".',INVALID_GROUP_BY_PROPERTY:'Invalid groupBy property "%s". Allowed types: "%s", but given "%s".',UNKNOWN_FILTER_PROPERTY:'Unknown filter property "%s".',INVALID_VECTOR_SIZE:'Vector size must be a number greater than 0. Got "%s" instead.',INVALID_VECTOR_VALUE:'Vector value must be a number greater than 0. Got "%s" instead.',INVALID_INPUT_VECTOR:`Property "%s" was declared as a %s-dimensional vector, but got a %s-dimensional vector instead.
Input vectors must be of the size declared in the schema, as calculating similarity between vectors of different sizes can lead to unexpected results.`,WRONG_SEARCH_PROPERTY_TYPE:'Property "%s" is not searchable. Only "string" properties are searchable.',FACET_NOT_SUPPORTED:'Facet doens\'t support the type "%s".',INVALID_DISTANCE_SUFFIX:'Invalid distance suffix "%s". Valid suffixes are: cm, m, km, mi, yd, ft.'},lastId=0,nano=BigInt(1e3),milli=BigInt(1e6),second=BigInt(1e9),MAX_ARGUMENT_FOR_STACK=65535;function safeArrayPush(e,t){if(t.length<65535)Array.prototype.push.apply(e,t);else for(let r=0;r<t.length;r+=65535)Array.prototype.push.apply(e,t.slice(r,r+65535))}function sprintf(e,...t){return e.replace(/%(?:(?<position>\d+)\$)?(?<width>-?\d*\.?\d*)(?<type>[dfs])/g,function(...e){let r=e[e.length-1],{width:n,type:o,position:i}=r,a=i?t[Number.parseInt(i)-1]:t.shift(),s=""===n?0:Number.parseInt(n);switch(o){case"d":return a.toString().padStart(s,"0");case"f":{let l=a,[u,f]=n.split(".").map(e=>Number.parseFloat(e));return"number"==typeof f&&f>=0&&(l=l.toFixed(f)),"number"==typeof u&&u>=0?l.toString().padStart(s,"0"):l.toString()}case"s":return s<0?a.toString().padEnd(-s," "):a.toString().padStart(s," ");default:return a}})}function createError(e,...t){let r=Error(sprintf(errors[e]??`Unsupported Orama Error code: ${e}`,...t));return r.code=e,"captureStackTrace"in Error.prototype&&Error.captureStackTrace(r),r}async function formatNanoseconds(e){return("number"==typeof e&&(e=BigInt(e)),e<nano)?`${e}ns`:e<milli?`${e/nano}μs`:e<second?`${e/milli}ms`:`${e/second}s`}async function getNanosecondsTime(){return"undefined"!=typeof process&&void 0!==process.hrtime?process.hrtime.bigint():"undefined"!=typeof performance?BigInt(Math.floor(1e6*performance.now())):BigInt(0)}async function uniqueId(){return`${baseId}-${lastId++}`}function getOwnProperty(e,t){return void 0===Object.hasOwn?Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0:Object.hasOwn(e,t)?e[t]:void 0}function sortTokenScorePredicate(e,t){return t[1]===e[1]?e[0]-t[0]:t[1]-e[1]}function intersect(e){if(0===e.length)return[];if(1===e.length)return e[0];for(let t=1;t<e.length;t++)if(e[t].length<e[0].length){let r=e[0];e[0]=e[t],e[t]=r}let n=new Map;for(let o of e[0])n.set(o,1);for(let i=1;i<e.length;i++){let a=0;for(let s of e[i]){let l=n.get(s);l===i&&(n.set(s,l+1),a++)}if(0===a)return[]}return e[0].filter(t=>{let r=n.get(t);return void 0!==r&&n.set(t,0),r===e.length})}async function getDocumentProperties(e,t){let r={},n=t.length;for(let o=0;o<n;o++){let i=t[o],a=i.split("."),s=e,l=a.length;for(let u=0;u<l;u++)if("object"==typeof(s=s[a[u]])){if(null!==s&&"lat"in s&&"lon"in s&&"number"==typeof s.lat&&"number"==typeof s.lon){s=r[i]=s;break}if(!Array.isArray(s)&&null!==s&&u===l-1){s=void 0;break}}else if((null===s||"object"!=typeof s)&&u<l-1){s=void 0;break}void 0!==s&&(r[i]=s)}return r}async function getNested(e,t){let r=await getDocumentProperties(e,[t]);return r[t]}let mapDistanceToMeters={cm:.01,m:1,km:1e3,ft:.3048,yd:.9144,mi:1609.344};function convertDistanceToMeters(e,t){let r=mapDistanceToMeters[t];if(void 0===r)throw Error(createError("INVALID_DISTANCE_SUFFIX",e).message);return e*r}async function formatElapsedTime(e){return{raw:Number(e),formatted:await formatNanoseconds(e)}}async function getDocumentIndexId(e){if(e.id){if("string"!=typeof e.id)throw createError("DOCUMENT_ID_MUST_BE_STRING",typeof e.id);return e.id}return await uniqueId()}async function validateSchema(e,t){for(let[r,n]of Object.entries(t)){let o=e[r];if(void 0!==o&&("geopoint"!==n||"object"!=typeof o||"number"!=typeof o.lon||"number"!=typeof o.lat)&&("enum"!==n||"string"!=typeof o&&"number"!=typeof o)){if("enum[]"===n&&Array.isArray(o)){let i=o.length;for(let a=0;a<i;a++)if("string"!=typeof o[a]&&"number"!=typeof o[a])return r+"."+a;continue}if(isVectorType(n)){let s=getVectorSize(n);if(!Array.isArray(o)||o.length!==s)throw createError("INVALID_INPUT_VECTOR",r,s,o.length);continue}if(isArrayType(n)){if(!Array.isArray(o))return r;let l=getInnerType(n),u=o.length;for(let f=0;f<u;f++)if(typeof o[f]!==l)return r+"."+f;continue}if("object"==typeof n){if(!o||"object"!=typeof o)return r;let d=await validateSchema(o,n);if(d)return r+"."+d;continue}if(typeof o!==n)return r}}}let IS_ARRAY_TYPE={string:!1,number:!1,boolean:!1,enum:!1,geopoint:!1,"string[]":!0,"number[]":!0,"boolean[]":!0,"enum[]":!0},INNER_TYPE={"string[]":"string","number[]":"number","boolean[]":"boolean","enum[]":"enum"};function isGeoPointType(e){return"geopoint"===e}function isVectorType(e){return"string"==typeof e&&/^vector\[\d+\]$/.test(e)}function isArrayType(e){return"string"==typeof e&&IS_ARRAY_TYPE[e]}function getInnerType(e){return INNER_TYPE[e]}function getVectorSize(e){let t=Number(e.slice(7,-1));switch(!0){case isNaN(t):throw createError("INVALID_VECTOR_VALUE",e);case t<=0:throw createError("INVALID_VECTOR_SIZE",e);default:return t}}function createInternalDocumentIDStore(){return{idToInternalId:new Map,internalIdToId:[],save,load}}function save(e){return{internalIdToId:e.internalIdToId}}function load(e,t){let{internalIdToId:r}=t;e.internalDocumentIDStore.idToInternalId.clear(),e.internalDocumentIDStore.internalIdToId=[];for(let n=0;n<r.length;n++)e.internalDocumentIDStore.idToInternalId.set(r[n],n+1),e.internalDocumentIDStore.internalIdToId.push(r[n])}function getInternalDocumentId(e,t){if("string"==typeof t){let r=e.idToInternalId.get(t);if(r)return r;let n=e.idToInternalId.size+1;return e.idToInternalId.set(t,n),e.internalIdToId.push(t),n}return t>e.internalIdToId.length?getInternalDocumentId(e,t.toString()):t}function getDocumentIdFromInternalId(e,t){if(e.internalIdToId.length<t)throw Error(`Invalid internalId ${t}`);return e.internalIdToId[t-1]}async function create(e,t){return{sharedInternalDocumentStore:t,docs:{},count:0}}async function get(e,t){let r=getInternalDocumentId(e.sharedInternalDocumentStore,t);return e.docs[r]}async function getMultiple(e,t){let r=Array.from({length:t.length});for(let n=0;n<t.length;n++){let o=getInternalDocumentId(e.sharedInternalDocumentStore,t[n]);r[n]=e.docs[o]}return r}async function getAll(e){return e.docs}async function store(e,t,r){let n=getInternalDocumentId(e.sharedInternalDocumentStore,t);return void 0===e.docs[n]&&(e.docs[n]=r,e.count++,!0)}async function remove(e,t){let r=getInternalDocumentId(e.sharedInternalDocumentStore,t);return void 0!==e.docs[r]&&(delete e.docs[r],e.count--,!0)}async function count(e){return e.count}async function load1(e,t){let r=t;return{docs:r.docs,count:r.count,sharedInternalDocumentStore:e}}async function save1(e){return{docs:e.docs,count:e.count}}async function createDocumentsStore(){return{create,get,getMultiple,getAll,store,remove,count,load:load1,save:save1}}let OBJECT_COMPONENTS=["tokenizer","index","documentsStore","sorter"],FUNCTION_COMPONENTS=["validateSchema","getDocumentIndexId","getDocumentProperties","formatElapsedTime"],SINGLE_OR_ARRAY_COMPONENTS=["beforeInsert","afterInsert","beforeRemove","afterRemove","beforeUpdate","afterUpdate","afterSearch","beforeMultipleInsert","afterMultipleInsert","beforeMultipleRemove","afterMultipleRemove","beforeMultipleUpdate","afterMultipleUpdate"];async function runSingleHook(e,t,r,n){let o=e.length;for(let i=0;i<o;i++)await e[i](t,r,n)}async function runMultipleHook(e,t,r){let n=e.length;for(let o=0;o<n;o++)await e[o](t,r)}async function runAfterSearch(e,t,r,n,o){let i=e.length;for(let a=0;a<i;a++)await e[a](t,r,n,o)}let BALANCE_STATE={UNBALANCED_RIGHT:-2,SLIGHTLY_UNBALANCED_RIGHT:-1,BALANCED:0,SLIGHTLY_UNBALANCED_LEFT:1,UNBALANCED_LEFT:2};function getHeight(e){return null!=e?e.h:-1}function rotateLeft(e){let t=e.r;return e.r=t.l,t.l=e,e.h=Math.max(getHeight(e.l),getHeight(e.r))+1,t.h=Math.max(getHeight(t.l),getHeight(t.r))+1,t}function rotateRight(e){let t=e.l;return e.l=t.r,t.r=e,e.h=Math.max(getHeight(e.l),getHeight(e.r))+1,t.h=Math.max(getHeight(t.l),getHeight(t.r))+1,t}function rangeSearch(e,t,r){if(!e)return[];let n=[];return!function e(o){o&&(o.k>t&&e(o.l),o.k>=t&&o.k<=r&&safeArrayPush(n,o.v),o.k<r&&e(o.r))}(e),n}function greaterThan(e,t,r=!1){if(!e)return[];let n=[];return!function e(o){o&&(r&&o.k>=t&&safeArrayPush(n,o.v),!r&&o.k>t&&safeArrayPush(n,o.v),e(o.l),e(o.r))}(e),n}function lessThan(e,t,r=!1){if(!e)return[];let n=[];return!function e(o){o&&(r&&o.k<=t&&safeArrayPush(n,o.v),!r&&o.k<t&&safeArrayPush(n,o.v),e(o.l),e(o.r))}(e),n}function getNodeByKey(e,t){for(;null!==e;)if(t<e.k)e=e.l;else{if(!(t>e.k))return e;e=e.r}return null}function create1(e,t){return{k:e,v:t,l:null,r:null,h:0}}function insert(e,t,r){let n=null,o=e;for(;null!==o;)if(n=o,t<o.k)o=o.l;else{if(!(t>o.k))return o.v=o.v.concat(r),e;o=o.r}let i=create1(t,r);for(null==n?e=i:t<n.k?n.l=i:n.r=i,o=i;null!=n;){let a=getHeight(n.l)-getHeight(n.r);if(a===BALANCE_STATE.UNBALANCED_LEFT&&(t>n.l.k&&(n.l=rotateLeft(n.l)),n=rotateRight(n)),a===BALANCE_STATE.UNBALANCED_RIGHT&&(t<n.r.k&&(n.r=rotateRight(n.r)),n=rotateLeft(n)),n===e)break;n=getNodeParent(e,(o=n).k)}return e}function getNodeParent(e,t){let r=e,n=null;for(;null!==r;)if(t<r.k)n=r,r=r.l;else if(t>r.k)n=r,r=r.r;else break;return n}function find(e,t){let r=getNodeByKey(e,t);return null==r?null:r.v}function remove1(e,t){let r=e,n=null;for(;null!=r&&r.k!==t;)n=r,r=t<r.k?r.l:r.r;if(null==r)return null;if(null==r.l&&null==r.r)null==n?e=null:n.l===r?n.l=null:n.r=null;else if(null!=r.l&&null!=r.r){let o=r.r,i=r;for(;null!=o.l;)i=o,o=o.l;r.k=o.k,i===r?i.r=o.r:i.l=o.r}else{let a=null!=r.l?r.l:r.r;null==n?e=a:n.l===r?n.l=a:n.r=a}return e}function removeDocument(e,t,r){let n=getNodeByKey(e,r);if(n){if(1===n.v.length){remove1(e,r);return}n.v.splice(n.v.indexOf(t),1)}}function create2(){return{numberToDocumentId:new Map}}function insert1(e,t,r){return e.numberToDocumentId.has(t)?(e.numberToDocumentId.get(t).push(r),e):(e.numberToDocumentId.set(t,[r]),e)}function removeDocument1(e,t,r){var n,o;null==e||e.numberToDocumentId.set(r,(null===(n=null==e?void 0:e.numberToDocumentId.get(r))||void 0===n?void 0:n.filter(e=>e!==t))??[]),(null===(o=null==e?void 0:e.numberToDocumentId.get(r))||void 0===o?void 0:o.length)===0&&(null==e||e.numberToDocumentId.delete(r))}function filter(e,t){let r=Object.keys(t);if(1!==r.length)throw Error("Invalid operation");let n=r[0];switch(n){case"eq":{let o=t[n];return e.numberToDocumentId.get(o)??[]}case"in":{let i=t[n],a=[];for(let s of i){let l=e.numberToDocumentId.get(s);null!=l&&safeArrayPush(a,l)}return a}case"nin":{let u=t[n],f=[],d=e.numberToDocumentId.keys();for(let h of d){if(u.includes(h))continue;let g=e.numberToDocumentId.get(h);null!=g&&safeArrayPush(f,g)}return f}}throw Error("Invalid operation")}function filterArr(e,t){let r=Object.keys(t);if(1!==r.length)throw Error("Invalid operation");let n=r[0];if("containsAll"===n){let o=t[n],i=o.map(t=>e.numberToDocumentId.get(t)??[]);return intersect(i)}throw Error("Invalid operation")}function _boundedLevenshtein(e,t,r){if(e===t)return 0;let n=e;e.length>t.length&&(e=t,t=n);let o=e.length,i=t.length;for(;o>0&&e.charCodeAt(~-o)===t.charCodeAt(~-i);)o--,i--;if(!o)return i>r?-1:i;let a=0;for(;a<o&&e.charCodeAt(a)===t.charCodeAt(a);)a++;if(o-=a,i-=a,0===o)return i>r?-1:i;let s=i-o;if(r>i)r=i;else if(s>r)return -1;let l=0,u=[],f=[];for(;l<r;)f[l]=t.charCodeAt(a+l),u[l]=++l;for(;l<i;)f[l]=t.charCodeAt(a+l),u[l++]=r+1;let d=r-s,h=r<i,g=0,m=r,p=0,$=0,_=0,I=0,y=0;for(l=0;l<o;l++){for($=l,p=l+1,I=e.charCodeAt(a+l),g+=l>d?1:0,m+=m<i?1:0,y=g;y<m;y++)_=p,p=$,$=u[y],I!==f[y]&&($<p&&(p=$),_<p&&(p=_),p++),u[y]=p;if(h&&u[l+s]>r)return -1}return p<=r?p:-1}function syncBoundedLevenshtein(e,t,r){let n=_boundedLevenshtein(e,t,r);return{distance:n,isBounded:n>=0}}class Node{constructor(e,t,r){this.k=e,this.s=t,this.e=r}c={};d=[];w="";toJSON(){return{w:this.w,s:this.s,c:this.c,d:this.d,e:this.e}}}function updateParent(e,t){e.w=t.w+e.s}function addDocument(e,t){e.d.push(t)}function removeDocument2(e,t){let r=e.d.indexOf(t);return -1!==r&&(e.d.splice(r,1),!0)}function findAllWords(e,t,r,n,o){if(e.e){let{w:i,d:a}=e;if(n&&i!==r)return{};if(null==getOwnProperty(t,i)){if(o){let s=Math.abs(r.length-i.length);s<=o&&syncBoundedLevenshtein(r,i,o).isBounded&&(t[i]=[])}else t[i]=[]}if(null!=getOwnProperty(t,i)&&a.length>0){let l=new Set(t[i]),u=a.length;for(let f=0;f<u;f++)l.add(a[f]);t[i]=Array.from(l)}}for(let d of Object.keys(e.c))findAllWords(e.c[d],t,r,n,o);return t}function getCommonPrefix(e,t){let r="",n=Math.min(e.length,t.length);for(let o=0;o<n&&e[o]===t[o];o++)r+=e[o];return r}function create3(e=!1,t="",r=""){return new Node(r,t,e)}function insert2(e,t,r){for(let n=0;n<t.length;n++){let o=t[n],i=t.substring(n),a=e.c[o];if(a){let s=a.s,l=s.length,u=getCommonPrefix(s,i),f=u.length;if(s===i){addDocument(a,r),a.e=!0;return}let d=s[f];if(f<l&&f===i.length){let h=create3(!0,i,o);h.c[d]=a;let g=h.c[d];g.s=s.substring(f),g.k=d,e.c[o]=h,updateParent(h,e),updateParent(g,h),addDocument(h,r);return}if(f<l&&f<i.length){let m=create3(!1,u,o);m.c[d]=a,e.c[o]=m;let p=m.c[d];p.s=s.substring(f),p.k=d;let $=i[f],_=create3(!0,t.substring(n+f),$);addDocument(_,r),m.c[$]=_,updateParent(m,e),updateParent(_,m),updateParent(p,m);return}n+=l-1,e=a}else{let I=create3(!0,i,o);addDocument(I,r),e.c[o]=I,updateParent(I,e);return}}}function _findLevenshtein(e,t,r,n,o,i){if(!(n<0)){if(e.e){let{w:a,d:s}=e;if(a){let l=Math.abs(t.length-a.length);if(l<=o&&syncBoundedLevenshtein(t,a,o).isBounded&&(i[a]=[]),null!=getOwnProperty(i,a)&&s.length>0){let u=new Set(i[a]),f=s.length;for(let d=0;d<f;d++)u.add(s[d]);i[a]=Array.from(u)}}}if(!(r>=t.length)){for(let h in t[r]in e.c&&_findLevenshtein(e.c[t[r]],t,r+1,n,o,i),_findLevenshtein(e,t,r+1,n-1,o,i),e.c)_findLevenshtein(e.c[h],t,r,n-1,o,i);for(let g in e.c)g!==t[r]&&_findLevenshtein(e.c[g],t,r+1,n-1,o,i)}}}function find1(e,{term:t,exact:r,tolerance:n}){if(n&&!r){let o={};return _findLevenshtein(e,t,0,(n=n||0)||0,n,o),o}{for(let i=0;i<t.length;i++){let a=t[i];if(!(a in e.c))return{};{let s=e.c[a],l=s.s,u=t.substring(i),f=getCommonPrefix(l,u),d=f.length;if(d!==l.length&&d!==u.length){if(n)break;return{}}i+=s.s.length-1,e=s}}let h={};return findAllWords(e,h,t,r,n),h}}function removeDocumentByWord(e,t,r,n=!0){if(!t)return!0;for(let o=0;o<t.length;o++){let i=t[o];if(!(i in e.c))return!1;{let a=e.c[i];o+=a.s.length-1,e=a,n&&e.w!==t||removeDocument2(e,r)}}return!0}function create4(){return{root:null}}function insert3(e,t,r){let n={point:t,docIDs:r};if(null==e.root){e.root=n;return}let o=e.root,i=0;for(;null!==o;){if(o.point.lon===t.lon&&o.point.lat===t.lat){let a=o.docIDs??[];o.docIDs=Array.from(new Set([...a,...r||[]]));return}let s=i%2;if(0===s){if(t.lon<o.point.lon){if(null==o.left){o.left=n;return}o=o.left}else{if(null==o.right){o.right=n;return}o=o.right}}else if(t.lat<o.point.lat){if(null==o.left){o.left=n;return}o=o.left}else{if(null==o.right){o.right=n;return}o=o.right}i++}}function removeDocByID(e,t,r){let n=e.root,o=0,i=null,a=null;for(;null!==n;){if((null==n?void 0:n.point.lon)===t.lon&&n.point.lat===t.lat){var s,l;let u=null===(s=n.docIDs)||void 0===s?void 0:s.indexOf(r);if(void 0!==u&&u>-1){null===(l=n.docIDs)||void 0===l||l.splice(u,1),(null==n.docIDs||0===n.docIDs.length)&&(null!=i?"left"===a?i.left=null!==n.left?n.left:n.right:"right"===a&&(i.right=null!==n.right?n.right:n.left):e.root=null!==n.left?n.left:n.right);return}}let f=o%2;i=n,0===f?t.lon<n.point.lon?(n=null==n?void 0:n.left,a="left"):(n=null==n?void 0:n.right,a="right"):t.lat<n.point.lat?(n=null==n?void 0:n.left,a="left"):(n=null==n?void 0:n.right,a="right"),o++}}function searchByRadius(e,t,r,n=!0,o="asc",i=!1){let a=i?vincentyDistance:haversineDistance,s=[{node:e,depth:0}],l=[];for(;s.length>0;){let{node:u,depth:f}=s.pop();if(null===u)continue;let d=a(t,u.point);(n?d<=r:d>r)&&l.push({point:u.point,docIDs:u.docIDs??[]}),null!=u.left&&s.push({node:u.left,depth:f+1}),null!=u.right&&s.push({node:u.right,depth:f+1})}return o&&l.sort((e,r)=>{let n=a(t,e.point),i=a(t,r.point);return"asc"===o.toLowerCase()?n-i:i-n}),l}function searchByPolygon(e,t,r=!0,n=null,o=!1){let i=[{node:e,depth:0}],a=[];for(;i.length>0;){let s=i.pop();if(null==s||null==s.node)continue;let{node:l,depth:u}=s,f=u+1;null!=l.left&&i.push({node:l.left,depth:f}),null!=l.right&&i.push({node:l.right,depth:f});let d=isPointInPolygon(t,l.point);d&&r?a.push({point:l.point,docIDs:l.docIDs??[]}):d||r||a.push({point:l.point,docIDs:l.docIDs??[]})}let h=calculatePolygonCentroid(t);if(n){let g=o?vincentyDistance:haversineDistance;a.sort((e,t)=>{let r=g(h,e.point),o=g(h,t.point);return"asc"===n.toLowerCase()?r-o:o-r})}return a}function calculatePolygonCentroid(e){let t=0,r=0,n=0;for(let o=0,i=e.length-1;o<e.length;i=o++){let a=e[o].lon,s=e[o].lat,l=e[i].lon,u=e[i].lat,f=a*u-l*s;t+=f,r+=(a+l)*f,n+=(s+u)*f}return t/=2,{lon:r/=6*t,lat:n/=6*t}}function isPointInPolygon(e,t){let r=!1,n=t.lon,o=t.lat;for(let i=0,a=e.length-1;i<e.length;a=i++){let s=e[i].lon,l=e[i].lat,u=e[a].lon,f=e[a].lat,d=l>o!=f>o&&n<(u-s)*(o-l)/(f-l)+s;d&&(r=!r)}return r}function haversineDistance(e,t){let r=Math.PI/180,n=e.lat*r,o=t.lat*r,i=(t.lat-e.lat)*r,a=(t.lon-e.lon)*r,s=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(o)*Math.sin(a/2)*Math.sin(a/2);return 6371e3*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function vincentyDistance(e,t){let r=1/298.257223563,n=(1-r)*6378137,o=Math.PI/180,i=e.lat*o,a=t.lat*o,s=(t.lon-e.lon)*o,l=Math.atan((1-r)*Math.tan(i)),u=Math.atan((1-r)*Math.tan(a)),f=Math.sin(l),d=Math.cos(l),h=Math.sin(u),g=Math.cos(u),m=s,p,$=1e3,_,I,y,T,S;do{let D=Math.sin(m),b=Math.cos(m);S=Math.atan2(y=Math.sqrt(g*D*(g*D)+(d*h-f*g*b)*(d*h-f*g*b)),T=f*h+d*g*b),I=1-(_=d*g*D/y)*_;let E=T-2*f*h/I,P=r/16*I*(4+r*(4-3*I));p=m,m=s+(1-P)*r*_*(S+P*y*(E+P*T*(-1+2*E*E)))}while(Math.abs(m-p)>1e-12&&--$>0);let A=I*(40680631590769-n*n)/(n*n),N=A/1024*(256+A*(-128+A*(74-47*A))),w=N*y*(T-2*f*h/I+N/4*(T*(-1+2*y*y)-N/6*S*(-3+4*y*y)*(-3+4*S*S))),O=n*(1+A/16384*(4096+A*(-768+A*(320-175*A))))*(S-w);return O}function prioritizeTokenScores(e,t,r=1,n){if(0===t)throw createError("INVALID_BOOST_VALUE");let o=new Map,i=new Map,a=e.length;for(let s=0;s<a;s++){let l=e[s],u=l.length;for(let f=0;f<u;f++){let[d,h]=l[f],g=h*t,m=o.get(d);void 0!==m?(o.set(d,1.5*m+g),i.set(d,i.get(d)+1)):(o.set(d,g),i.set(d,1))}}let p=[];for(let $ of o.entries())p.push($);let _=p.sort((e,t)=>t[1]-e[1]);if(1===r)return _;let I=_.length,y=[];for(let T of i.entries())y.push(T);let S=y.sort((e,t)=>t[1]-e[1]),D;for(let b=0;b<I;b++)if(S[b][1]===n)D=b;else break;if(void 0===D){if(0===r)return[];D=0}if(0===r)return _.slice(0,D+1);let E=D+Math.ceil(100*r*(_.length-D)/100);return _.slice(0,_.length+E)}function BM25(e,t,r,n,o,i){let{k:a,b:s,d:l}=i;return Math.log(1+(r-t+.5)/(t+.5))*(l+e*(a+1))/(e+a*(1-s+s*n/o))}function getMagnitude(e,t){let r=0;for(let n=0;n<t;n++)r+=e[n]*e[n];return Math.sqrt(r)}async function insertDocumentScoreParameters(e,t,r,n,o){let i=getInternalDocumentId(e.sharedInternalDocumentStore,r);e.avgFieldLength[t]=((e.avgFieldLength[t]??0)*(o-1)+n.length)/o,e.fieldLengths[t][i]=n.length,e.frequencies[t][i]={}}async function insertTokenScoreParameters(e,t,r,n,o){let i=0;for(let a of n)a===o&&i++;let s=getInternalDocumentId(e.sharedInternalDocumentStore,r),l=i/n.length;e.frequencies[t][s][o]=l,o in e.tokenOccurrences[t]||(e.tokenOccurrences[t][o]=0),e.tokenOccurrences[t][o]=(e.tokenOccurrences[t][o]??0)+1}async function removeDocumentScoreParameters(e,t,r,n){let o=getInternalDocumentId(e.sharedInternalDocumentStore,r);e.avgFieldLength[t]=(e.avgFieldLength[t]*n-e.fieldLengths[t][o])/(n-1),e.fieldLengths[t][o]=void 0,e.frequencies[t][o]=void 0}async function removeTokenScoreParameters(e,t,r){e.tokenOccurrences[t][r]--}async function calculateResultScores(e,t,r,n,o){let i=Array.from(o),a=t.avgFieldLength[r],s=t.fieldLengths[r],l=t.tokenOccurrences[r],u=t.frequencies[r],f="number"==typeof l[n]?l[n]??0:0,d=[],h=i.length;for(let g=0;g<h;g++){var m;let p=getInternalDocumentId(t.sharedInternalDocumentStore,i[g]),$=(null==u?void 0:null===(m=u[p])||void 0===m?void 0:m[n])??0,_=BM25($,f,e.docsCount,s[p],a,e.params.relevance);d.push([p,_])}return d}async function create5(e,t,r,n,o=""){for(let[i,a]of(n||(n={sharedInternalDocumentStore:t,indexes:{},vectorIndexes:{},searchableProperties:[],searchablePropertiesWithTypes:{},frequencies:{},tokenOccurrences:{},avgFieldLength:{},fieldLengths:{}}),Object.entries(r))){let s=`${o}${o?".":""}${i}`;if("object"==typeof a&&!Array.isArray(a)){create5(e,t,a,n,s);continue}if(isVectorType(a))n.searchableProperties.push(s),n.searchablePropertiesWithTypes[s]=a,n.vectorIndexes[s]={size:getVectorSize(a),vectors:{}};else{let l=/\[/.test(a);switch(a){case"boolean":case"boolean[]":n.indexes[s]={type:"Bool",node:{true:[],false:[]},isArray:l};break;case"number":case"number[]":n.indexes[s]={type:"AVL",node:create1(0,[]),isArray:l};break;case"string":case"string[]":n.indexes[s]={type:"Radix",node:create3(),isArray:l},n.avgFieldLength[s]=0,n.frequencies[s]={},n.tokenOccurrences[s]={},n.fieldLengths[s]={};break;case"enum":case"enum[]":n.indexes[s]={type:"Flat",node:create2(),isArray:l};break;case"geopoint":n.indexes[s]={type:"BKD",node:create4(),isArray:l};break;default:throw createError("INVALID_SCHEMA_TYPE",Array.isArray(a)?"array":a,s)}n.searchableProperties.push(s),n.searchablePropertiesWithTypes[s]=a}}return n}async function insertScalar(e,t,r,n,o,i,a,s,l){let u=getInternalDocumentId(t.sharedInternalDocumentStore,n),{type:f,node:d}=t.indexes[r];switch(f){case"Bool":d[o?"true":"false"].push(u);break;case"AVL":insert(d,o,[u]);break;case"Radix":{let h=await s.tokenize(o,a,r);for(let g of(await e.insertDocumentScoreParameters(t,r,u,h,l),h))await e.insertTokenScoreParameters(t,r,u,h,g),insert2(d,g,u);break}case"Flat":insert1(d,o,u);break;case"BKD":insert3(d,o,[u])}}async function insert4(e,t,r,n,o,i,a,s,l){if(isVectorType(i))return insertVector(t,r,o,n);if(!isArrayType(i))return insertScalar(e,t,r,n,o,i,a,s,l);let u=getInnerType(i),f=o,d=f.length;for(let h=0;h<d;h++)await insertScalar(e,t,r,n,f[h],u,a,s,l)}function insertVector(e,t,r,n){r instanceof Float32Array||(r=new Float32Array(r));let o=e.vectorIndexes[t].size,i=getMagnitude(r,o);e.vectorIndexes[t].vectors[n]=[i,r]}async function removeScalar(e,t,r,n,o,i,a,s,l){let u=getInternalDocumentId(t.sharedInternalDocumentStore,n);if(isVectorType(i))return delete t.vectorIndexes[r].vectors[n],!0;let{type:f,node:d}=t.indexes[r];switch(f){case"AVL":return removeDocument(d,u,o),!0;case"Bool":{let h=d[o?"true":"false"].indexOf(u);return d[o?"true":"false"].splice(h,1),!0}case"Radix":{let g=await s.tokenize(o,a,r);for(let m of(await e.removeDocumentScoreParameters(t,r,n,l),g))await e.removeTokenScoreParameters(t,r,m),removeDocumentByWord(d,m,u);return!0}case"Flat":return removeDocument1(d,u,o),!0;case"BKD":return removeDocByID(d,o,u),!1}}async function remove2(e,t,r,n,o,i,a,s,l){if(!isArrayType(i))return removeScalar(e,t,r,n,o,i,a,s,l);let u=getInnerType(i),f=o,d=f.length;for(let h=0;h<d;h++)await removeScalar(e,t,r,n,f[h],u,a,s,l);return!0}async function search(e,t,r,n){if(!(r in t.tokenOccurrences))return[];let{node:o,type:i}=t.indexes[r];if("Radix"!==i)throw createError("WRONG_SEARCH_PROPERTY_TYPE",r);let{exact:a,tolerance:s}=e.params,l=find1(o,{term:n,exact:a,tolerance:s}),u=new Set;for(let f in l)for(let d of l[f])u.add(d);return e.index.calculateResultScores(e,t,r,n,Array.from(u))}async function searchByWhereClause(e,t,r){let n=Object.keys(r),o=n.reduce((e,t)=>({[t]:[],...e}),{});for(let i of n){let a=r[i];if(void 0===t.indexes[i])throw createError("UNKNOWN_FILTER_PROPERTY",i);let{node:s,type:l,isArray:u}=t.indexes[i];if("Bool"===l){let f=s,d=f[a.toString()];safeArrayPush(o[i],d);continue}if("BKD"===l){let h;if("radius"in a)h="radius";else if("polygon"in a)h="polygon";else throw Error(`Invalid operation ${a}`);if("radius"===h){let{value:g,coordinates:m,unit:p="m",inside:$=!0,highPrecision:_=!1}=a[h],I=convertDistanceToMeters(g,p),y=searchByRadius(s.root,m,I,$,void 0,_);safeArrayPush(o[i],y.map(({docIDs:e})=>e).flat())}else{let{coordinates:T,inside:S=!0,highPrecision:D=!1}=a[h],b=searchByPolygon(s.root,T,S,void 0,D);safeArrayPush(o[i],b.map(({docIDs:e})=>e).flat())}continue}if("Radix"===l&&("string"==typeof a||Array.isArray(a))){for(let E of[a].flat()){let P=await e.tokenizer.tokenize(E,e.language,i);for(let A of P){let N=find1(s,{term:A,exact:!0});safeArrayPush(o[i],Object.values(N).flat())}}continue}let w=Object.keys(a);if(w.length>1)throw createError("INVALID_FILTER_OPERATION",w.length);if("Flat"===l){u?safeArrayPush(o[i],filterArr(s,a)):safeArrayPush(o[i],filter(s,a));continue}if("AVL"===l){let O=w[0],k=a[O],R=[];switch(O){case"gt":R=greaterThan(s,k,!1);break;case"gte":R=greaterThan(s,k,!0);break;case"lt":R=lessThan(s,k,!1);break;case"lte":R=lessThan(s,k,!0);break;case"eq":R=find(s,k)??[];break;case"between":{let[L,x]=k;R=rangeSearch(s,L,x)}}safeArrayPush(o[i],R)}}let U=intersect(Object.values(o));return U}async function getSearchableProperties(e){return e.searchableProperties}async function getSearchablePropertiesWithTypes(e){return e.searchablePropertiesWithTypes}function loadRadixNode(e){let t=create3(e.e,e.s,e.k);for(let r of(t.d=e.d,t.w=e.w,Object.keys(e.c)))t.c[r]=loadRadixNode(e.c[r]);return t}function loadFlatNode(e){return{numberToDocumentId:new Map(e)}}function saveFlatNode(e){return Array.from(e.numberToDocumentId.entries())}async function load2(e,t){let{indexes:r,vectorIndexes:n,searchableProperties:o,searchablePropertiesWithTypes:i,frequencies:a,tokenOccurrences:s,avgFieldLength:l,fieldLengths:u}=t,f={},d={};for(let h of Object.keys(r)){let{node:g,type:m,isArray:p}=r[h];switch(m){case"Radix":f[h]={type:"Radix",node:loadRadixNode(g),isArray:p};break;case"Flat":f[h]={type:"Flat",node:loadFlatNode(g),isArray:p};break;default:f[h]=r[h]}}for(let $ of Object.keys(n)){let _=n[$].vectors;for(let I in _)_[I]=[_[I][0],new Float32Array(_[I][1])];d[$]={size:n[$].size,vectors:_}}return{sharedInternalDocumentStore:e,indexes:f,vectorIndexes:d,searchableProperties:o,searchablePropertiesWithTypes:i,frequencies:a,tokenOccurrences:s,avgFieldLength:l,fieldLengths:u}}async function save2(e){let{indexes:t,vectorIndexes:r,searchableProperties:n,searchablePropertiesWithTypes:o,frequencies:i,tokenOccurrences:a,avgFieldLength:s,fieldLengths:l}=e,u={};for(let f of Object.keys(r)){let d=r[f].vectors;for(let h in d)d[h]=[d[h][0],Array.from(d[h][1])];u[f]={size:r[f].size,vectors:d}}let g={};for(let m of Object.keys(t)){let{type:p,node:$,isArray:_}=t[m];if("Flat"!==p){g[m]=t[m];continue}g[m]={type:"Flat",node:saveFlatNode($),isArray:_}}return{indexes:g,vectorIndexes:u,searchableProperties:n,searchablePropertiesWithTypes:o,frequencies:i,tokenOccurrences:a,avgFieldLength:s,fieldLengths:l}}async function createIndex(){return{create:create5,insert:insert4,remove:remove2,insertDocumentScoreParameters,insertTokenScoreParameters,removeDocumentScoreParameters,removeTokenScoreParameters,calculateResultScores,search,searchByWhereClause,getSearchableProperties,getSearchablePropertiesWithTypes,load:load2,save:save2}}function innerCreate(e,t,r,n,o){let i={language:e.tokenizer.language,sharedInternalDocumentStore:t,enabled:!0,isSorted:!0,sortableProperties:[],sortablePropertiesWithTypes:{},sorts:{}};for(let[a,s]of Object.entries(r)){let l=`${o}${o?".":""}${a}`;if(!n.includes(l)){if("object"==typeof s&&!Array.isArray(s)){let u=innerCreate(e,t,s,n,l);safeArrayPush(i.sortableProperties,u.sortableProperties),i.sorts={...i.sorts,...u.sorts},i.sortablePropertiesWithTypes={...i.sortablePropertiesWithTypes,...u.sortablePropertiesWithTypes};continue}if(!isVectorType(s))switch(s){case"boolean":case"number":case"string":i.sortableProperties.push(l),i.sortablePropertiesWithTypes[l]=s,i.sorts[l]={docs:new Map,orderedDocsToRemove:new Map,orderedDocs:[],type:s};break;case"geopoint":case"enum":case"enum[]":case"boolean[]":case"number[]":case"string[]":continue;default:throw createError("INVALID_SORT_SCHEMA_TYPE",Array.isArray(s)?"array":s,l)}}}return i}async function create6(e,t,r,n){let o=(null==n?void 0:n.enabled)!==!1;return o?innerCreate(e,t,r,(n||{}).unsortableProperties||[],""):{disabled:!0}}async function insert5(e,t,r,n){if(!e.enabled)return;e.isSorted=!1;let o=getInternalDocumentId(e.sharedInternalDocumentStore,r),i=e.sorts[t];i.docs.set(o,i.orderedDocs.length),i.orderedDocs.push([o,n])}function ensureIsSorted(e){if(e.isSorted||!e.enabled)return;let t=Object.keys(e.sorts);for(let r of t)ensurePropertyIsSorted(e,r);e.isSorted=!0}function stringSort(e,t,r){return t[1].localeCompare(r[1],e)}function numberSort(e,t){return e[1]-t[1]}function booleanSort(e,t){return t[1]?-1:1}function ensurePropertyIsSorted(e,t){let r=e.sorts[t],n;switch(r.type){case"string":n=stringSort.bind(null,e.language);break;case"number":n=numberSort.bind(null);break;case"boolean":n=booleanSort.bind(null)}r.orderedDocs.sort(n);let o=r.orderedDocs.length;for(let i=0;i<o;i++){let a=r.orderedDocs[i][0];r.docs.set(a,i)}}function ensureOrderedDocsAreDeleted(e){let t=Object.keys(e.sorts);for(let r of t)ensureOrderedDocsAreDeletedByProperty(e,r)}function ensureOrderedDocsAreDeletedByProperty(e,t){let r=e.sorts[t];r.orderedDocsToRemove.size&&(r.orderedDocs=r.orderedDocs.filter(e=>!r.orderedDocsToRemove.has(e[0])),r.orderedDocsToRemove.clear())}async function remove3(e,t,r){if(!e.enabled)return;let n=e.sorts[t],o=getInternalDocumentId(e.sharedInternalDocumentStore,r),i=n.docs.get(o);i&&(n.docs.delete(o),n.orderedDocsToRemove.set(o,!0))}async function sortBy(e,t,r){if(!e.enabled)throw createError("SORT_DISABLED");let n=r.property,o="DESC"===r.order,i=e.sorts[n];if(!i)throw createError("UNABLE_TO_SORT_ON_UNKNOWN_FIELD",n,e.sortableProperties.join(", "));return ensureOrderedDocsAreDeletedByProperty(e,n),ensureIsSorted(e),t.sort((t,r)=>{let n=i.docs.get(getInternalDocumentId(e.sharedInternalDocumentStore,t[0])),a=i.docs.get(getInternalDocumentId(e.sharedInternalDocumentStore,r[0])),s=void 0!==n,l=void 0!==a;return s||l?s?l?o?a-n:n-a:-1:1:0}),t}async function getSortableProperties(e){return e.enabled?e.sortableProperties:[]}async function getSortablePropertiesWithTypes(e){return e.enabled?e.sortablePropertiesWithTypes:{}}async function load3(e,t){let r=t;if(!r.enabled)return{enabled:!1};let n=Object.keys(r.sorts).reduce((e,t)=>{let{docs:n,orderedDocs:o,type:i}=r.sorts[t];return e[t]={docs:new Map(Object.entries(n).map(([e,t])=>[+e,t])),orderedDocsToRemove:new Map,orderedDocs:o,type:i},e},{});return{sharedInternalDocumentStore:e,language:r.language,sortableProperties:r.sortableProperties,sortablePropertiesWithTypes:r.sortablePropertiesWithTypes,sorts:n,enabled:!0,isSorted:r.isSorted}}async function save3(e){if(!e.enabled)return{enabled:!1};ensureOrderedDocsAreDeleted(e),ensureIsSorted(e);let t=Object.keys(e.sorts).reduce((t,r)=>{let{docs:n,orderedDocs:o,type:i}=e.sorts[r];return t[r]={docs:Object.fromEntries(n.entries()),orderedDocs:o,type:i},t},{});return{language:e.language,sortableProperties:e.sortableProperties,sortablePropertiesWithTypes:e.sortablePropertiesWithTypes,sorts:t,enabled:e.enabled,isSorted:e.isSorted}}async function createSorter(){return{create:create6,insert:insert5,remove:remove3,save:save3,load:load3,sortBy,getSortableProperties,getSortablePropertiesWithTypes}}let CHARCODE_REPLACE_MAPPING=[65,65,65,65,65,65,65,67,69,69,69,69,73,73,73,73,69,78,79,79,79,79,79,null,79,85,85,85,85,89,80,115,97,97,97,97,97,97,97,99,101,101,101,101,105,105,105,105,101,110,111,111,111,111,111,null,111,117,117,117,117,121,112,121,65,97,65,97,65,97,67,99,67,99,67,99,67,99,68,100,68,100,69,101,69,101,69,101,69,101,69,101,71,103,71,103,71,103,71,103,72,104,72,104,73,105,73,105,73,105,73,105,73,105,73,105,74,106,75,107,107,76,108,76,108,76,108,76,108,76,108,78,110,78,110,78,110,110,78,110,79,111,79,111,79,111,79,111,82,114,82,114,82,114,83,115,83,115,83,115,83,115,84,116,84,116,84,116,85,117,85,117,85,117,85,117,85,117,85,117,87,119,89,121,89,90,122,90,122,90,122,115];function replaceChar(e){return e<192||e>383?e:CHARCODE_REPLACE_MAPPING[e-192]||e}function replaceDiacritics(e){let t=[];for(let r=0;r<e.length;r++)t[r]=replaceChar(e.charCodeAt(r));return String.fromCharCode(...t)}let step2List={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},step3List={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},c="[^aeiou]",v="[aeiouy]",C="[^aeiou][^aeiouy]*",V=v+"[aeiou]*",mgr0="^("+C+")?"+V+C,meq1="^("+C+")?"+V+C+"("+V+")?$",mgr1="^("+C+")?"+V+C+V+C,s_v="^("+C+")?"+v;function stemmer(e){let t,r,n,o,i,a;if(e.length<3)return e;let s=e.substring(0,1);if("y"==s&&(e=s.toUpperCase()+e.substring(1)),o=/^(.+?)([^s])s$/,(n=/^(.+?)(ss|i)es$/).test(e)?e=e.replace(n,"$1$2"):o.test(e)&&(e=e.replace(o,"$1$2")),o=/^(.+?)(ed|ing)$/,(n=/^(.+?)eed$/).test(e)){let l=n.exec(e);(n=RegExp(mgr0)).test(l[1])&&(n=/.$/,e=e.replace(n,""))}else if(o.test(e)){let u=o.exec(e);t=u[1],(o=RegExp(s_v)).test(t)&&(e=t,o=/(at|bl|iz)$/,i=RegExp("([^aeiouylsz])\\1$"),a=RegExp("^"+C+v+"[^aeiouwxy]$"),o.test(e)?e+="e":i.test(e)?(n=/.$/,e=e.replace(n,"")):a.test(e)&&(e+="e"))}if((n=/^(.+?)y$/).test(e)){let f=n.exec(e);t=null==f?void 0:f[1],n=RegExp(s_v),t&&n.test(t)&&(e=t+"i")}if((n=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/).test(e)){let d=n.exec(e);t=null==d?void 0:d[1],r=null==d?void 0:d[2],n=RegExp(mgr0),t&&n.test(t)&&(e=t+step2List[r])}if((n=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/).test(e)){let h=n.exec(e);t=null==h?void 0:h[1],r=null==h?void 0:h[2],n=RegExp(mgr0),t&&n.test(t)&&(e=t+step3List[r])}if(o=/^(.+?)(s|t)(ion)$/,(n=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/).test(e)){let g=n.exec(e);t=null==g?void 0:g[1],n=RegExp(mgr1),t&&n.test(t)&&(e=t)}else if(o.test(e)){let m=o.exec(e);t=(null==m?void 0:m[1])??""+(null==m?void 0:m[2])??"",(o=RegExp(mgr1)).test(t)&&(e=t)}if((n=/^(.+?)e$/).test(e)){let p=n.exec(e);t=null==p?void 0:p[1],n=RegExp(mgr1),o=RegExp(meq1),i=RegExp("^"+C+v+"[^aeiouwxy]$"),t&&(n.test(t)||o.test(t)&&!i.test(t))&&(e=t)}return n=/ll$/,o=RegExp(mgr1),n.test(e)&&o.test(e)&&(n=/.$/,e=e.replace(n,"")),"y"==s&&(e=s.toLowerCase()+e.substring(1)),e}function normalizeToken(e,t){var r;let n=`${this.language}:${e}:${t}`;return this.normalizationCache.has(n)?this.normalizationCache.get(n):(null===(r=this.stopWords)||void 0===r?void 0:r.includes(t))?(this.normalizationCache.set(n,""),""):(this.stemmer&&!this.stemmerSkipProperties.has(e)&&(t=this.stemmer(t)),t=replaceDiacritics(t),this.normalizationCache.set(n,t),t)}function trim(e){for(;""===e[e.length-1];)e.pop();for(;""===e[0];)e.shift();return e}function tokenize(e,t,r){if(t&&t!==this.language)throw createError("LANGUAGE_NOT_SUPPORTED",t);if("string"!=typeof e)return[e];let n;if(r&&this.tokenizeSkipProperties.has(r))n=[this.normalizeToken.bind(this,r??"")(e)];else{let o=SPLITTERS[this.language];n=e.toLowerCase().split(o).map(this.normalizeToken.bind(this,r??"")).filter(Boolean)}let i=trim(n);return this.allowDuplicates?i:Array.from(new Set(i))}async function createTokenizer(e={}){if(e.language){if(!SUPPORTED_LANGUAGES.includes(e.language))throw createError("LANGUAGE_NOT_SUPPORTED",e.language)}else e.language="english";let t;if(e.stemming||e.stemmer&&!("stemming"in e)){if(e.stemmer){if("function"!=typeof e.stemmer)throw createError("INVALID_STEMMER_FUNCTION_TYPE");t=e.stemmer}else if("english"===e.language)t=stemmer;else throw createError("MISSING_STEMMER",e.language)}let r;if(!1!==e.stopWords){if(r=[],Array.isArray(e.stopWords))r=e.stopWords;else if("function"==typeof e.stopWords)r=await e.stopWords(r);else if(e.stopWords)throw createError("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");if(!Array.isArray(r))throw createError("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");for(let n of r)if("string"!=typeof n)throw createError("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY")}let o={tokenize,language:e.language,stemmer:t,stemmerSkipProperties:new Set(e.stemmerSkipProperties?[e.stemmerSkipProperties].flat():[]),tokenizeSkipProperties:new Set(e.tokenizeSkipProperties?[e.tokenizeSkipProperties].flat():[]),stopWords:r,allowDuplicates:Boolean(e.allowDuplicates),normalizeToken,normalizationCache:new Map};return o.tokenize=tokenize.bind(o),o.normalizeToken=normalizeToken,o}function validateComponents(e){let t={formatElapsedTime,getDocumentIndexId,getDocumentProperties,validateSchema};for(let r of FUNCTION_COMPONENTS){let n=r;if(e[n]){if("function"!=typeof e[n])throw createError("COMPONENT_MUST_BE_FUNCTION",n)}else e[n]=t[n]}for(let o of SINGLE_OR_ARRAY_COMPONENTS){let i=o,a=e[i];for(let s of(a?Array.isArray(e[i])||(e[i]=[e[i]]):e[i]=[],e[i]))if("function"!=typeof s)throw createError("COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS",i)}for(let l of Object.keys(e))if(!OBJECT_COMPONENTS.includes(l)&&!FUNCTION_COMPONENTS.includes(l)&&!SINGLE_OR_ARRAY_COMPONENTS.includes(l))throw createError("UNSUPPORTED_COMPONENT",l)}async function create7({schema:e,sort:t,language:r,components:n,id:o}){n||(n={}),o||(o=await uniqueId());let i=n.tokenizer,a=n.index,s=n.documentsStore,l=n.sorter;if(i){if(i.tokenize){let u=i;i=u}else i=await createTokenizer(i)}else i=await createTokenizer({language:r??"english"});if(n.tokenizer&&r)throw createError("NO_LANGUAGE_WITH_CUSTOM_TOKENIZER");let f=createInternalDocumentIDStore();a||=await createIndex(),l||=await createSorter(),s||=await createDocumentsStore(),validateComponents(n);let{getDocumentProperties:d,getDocumentIndexId:h,validateSchema:g,beforeInsert:m,afterInsert:p,beforeRemove:$,afterRemove:_,beforeUpdate:I,afterUpdate:y,afterSearch:T,beforeMultipleInsert:S,afterMultipleInsert:D,beforeMultipleRemove:b,afterMultipleRemove:E,beforeMultipleUpdate:P,afterMultipleUpdate:A,formatElapsedTime:N}=n,w={data:{},caches:{},schema:e,tokenizer:i,index:a,sorter:l,documentsStore:s,internalDocumentIDStore:f,getDocumentProperties:d,getDocumentIndexId:h,validateSchema:g,beforeInsert:m,afterInsert:p,beforeRemove:$,afterRemove:_,beforeUpdate:I,afterUpdate:y,afterSearch:T,beforeMultipleInsert:S,afterMultipleInsert:D,beforeMultipleRemove:b,afterMultipleRemove:E,beforeMultipleUpdate:P,afterMultipleUpdate:A,formatElapsedTime:N,id:o};return w.data={index:await w.index.create(w,f,e),docs:await w.documentsStore.create(w,f),sorting:await w.sorter.create(w,f,e,t)},w}let kInsertions=Symbol("orama.insertions"),kRemovals=Symbol("orama.removals");let warn=(null===(_globalThis_process=globalThis.process)||void 0===_globalThis_process?void 0:_globalThis_process.emitWarning)??function e(t,r){console.warn(`[WARNING] [${r.code}] ${t}`)};function trackInsertion(e){"number"!=typeof e[kInsertions]&&(queueMicrotask(()=>{e[kInsertions]=void 0}),e[kInsertions]=0),e[kInsertions]>1e3?(warn("Orama's insert operation is synchronous. Please avoid inserting a large number of document in a single operation in order not to block the main thread or, in alternative, please use insertMultiple.",{code:"ORAMA0001"}),e[kInsertions]=-1):e[kInsertions]>=0&&e[kInsertions]++}async function insert6(e,t,r,n){let o=await e.validateSchema(t,e.schema);if(o)throw createError("SCHEMA_VALIDATION_FAILURE",o);return innerInsert(e,t,r,n)}async function innerInsert(e,t,r,n){let{index:o,docs:i}=e.data,a=await e.getDocumentIndexId(t);if("string"!=typeof a)throw createError("DOCUMENT_ID_MUST_BE_STRING",typeof a);if(!await e.documentsStore.store(i,a,t))throw createError("DOCUMENT_ALREADY_EXISTS",a);let s=await e.documentsStore.count(i);n||await runSingleHook(e.beforeInsert,e,a,t);let l=await e.index.getSearchableProperties(o),u=await e.index.getSearchablePropertiesWithTypes(o),f=await e.getDocumentProperties(t,l);for(let[d,h]of Object.entries(f)){if(void 0===h)continue;let g=typeof h,m=u[d];if(!(isGeoPointType(m)&&"object"==typeof h&&"number"==typeof h.lon&&"number"==typeof h.lat||isVectorType(m)&&Array.isArray(h)||isArrayType(m)&&Array.isArray(h))&&("enum"!==m&&"enum[]"!==m||"string"!==g&&"number"!==g)&&g!==m)throw createError("INVALID_DOCUMENT_PROPERTY",d,m,g)}for(let p of l){var $,_,I,y;let T=f[p];if(void 0===T)continue;let S=u[p];await (null===(_=($=e.index).beforeInsert)||void 0===_?void 0:_.call($,e.data.index,p,a,T,S,r,e.tokenizer,s)),await e.index.insert(e.index,e.data.index,p,a,T,S,r,e.tokenizer,s),await (null===(y=(I=e.index).afterInsert)||void 0===y?void 0:y.call(I,e.data.index,p,a,T,S,r,e.tokenizer,s))}let D=await e.sorter.getSortableProperties(e.data.sorting),b=await e.sorter.getSortablePropertiesWithTypes(e.data.sorting),E=await e.getDocumentProperties(t,D);for(let P of D){let A=E[P];if(void 0===A)continue;let N=b[P];await e.sorter.insert(e.data.sorting,P,a,A,N,r)}return n||await runSingleHook(e.afterInsert,e,a,t),trackInsertion(e),a}async function insertMultiple(e,t,r,n,o){o||await runMultipleHook(e.beforeMultipleInsert,e,t);let i=t.length;for(let a=0;a<i;a++){let s=await e.validateSchema(t[a],e.schema);if(s)throw createError("SCHEMA_VALIDATION_FAILURE",s)}return innerInsertMultiple(e,t,r,n,o)}async function innerInsertMultiple(e,t,r,n,o){r||(r=1e3);let i=[];return await new Promise((a,s)=>{let l=0;async function u(){let f=t.slice(l*r,(l+1)*r);if(l++,!f.length)return a();for(let d of f)try{let h=await insert6(e,d,n,o);i.push(h)}catch(g){s(g)}setTimeout(u,0)}setTimeout(u,0)}),o||await runMultipleHook(e.afterMultipleInsert,e,t),i}function sortingPredicate(e="desc",t,r){return"asc"===e.toLowerCase()?t[1]-r[1]:r[1]-t[1]}async function getFacets(e,t,r){let n={},o=t.map(([e])=>e),i=await e.documentsStore.getMultiple(e.data.docs,o),a=Object.keys(r),s=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(let l of a){let u={};if("number"===s[l]){let{ranges:f}=r[l],d=[];for(let h of f)d.push([`${h.from}-${h.to}`,0]);u=Object.fromEntries(d)}n[l]={count:0,values:u}}let g=i.length;for(let m=0;m<g;m++){let p=i[m];for(let $ of a){let _=$.includes(".")?await getNested(p,$):p[$],I=s[$];switch(I){case"number":{let y=r[$].ranges;calculateNumberFacet(y,n[$].values,_);break}case"number[]":{let T=new Set,S=r[$].ranges;for(let D of _)calculateNumberFacet(S,n[$].values,D,T);break}case"boolean":case"enum":case"string":calculateBooleanStringOrEnumFacet(n[$].values,_,I);break;case"boolean[]":case"enum[]":case"string[]":{let b=new Set,E="boolean[]"===I?"boolean":"string";for(let P of _)calculateBooleanStringOrEnumFacet(n[$].values,P,E,b);break}default:throw createError("FACET_NOT_SUPPORTED",I)}}}for(let A of a)if(n[A].count=Object.keys(n[A].values).length,"string"===s[A]){let N=r;n[A].values=Object.fromEntries(Object.entries(n[A].values).sort((e,t)=>sortingPredicate(N.sort,e,t)).slice(N.offset??0,N.limit??10))}return n}function calculateNumberFacet(e,t,r,n){for(let o of e){let i=`${o.from}-${o.to}`;!(n&&n.has(i))&&r>=o.from&&r<=o.to&&(void 0===t[i]?t[i]=1:(t[i]++,n&&n.add(i)))}}function calculateBooleanStringOrEnumFacet(e,t,r,n){let o=(null==t?void 0:t.toString())??("boolean"===r?"false":"");!(n&&n.has(o))&&(e[o]=(e[o]??0)+1,n&&n.add(o))}function intersectFilteredIDs(e,t){let r=new Map,n=[];for(let o of e)r.set(o,!0);for(let[i,a]of t)r.has(i)&&(n.push([i,a]),r.delete(i));return n}let DEFAULT_REDUCE={reducer:(e,t,r,n)=>(t[n]=r,t),getInitialValue:e=>Array.from({length:e})},ALLOWED_TYPES=["string","number","boolean"];async function getGroups(e,t,r){let n=r.properties,o=n.length,i=await e.index.getSearchablePropertiesWithTypes(e.data.index);for(let a=0;a<o;a++){let s=n[a];if(void 0===i[s])throw createError("UNKNOWN_GROUP_BY_PROPERTY",s);if(!ALLOWED_TYPES.includes(i[s]))throw createError("INVALID_GROUP_BY_PROPERTY",s,ALLOWED_TYPES.join(", "),i[s])}let l=t.map(([t])=>getDocumentIdFromInternalId(e.internalDocumentIDStore,t)),u=await e.documentsStore.getMultiple(e.data.docs,l),f=u.length,d=r.maxResult||Number.MAX_SAFE_INTEGER,h=[],g={};for(let m=0;m<o;m++){let p=n[m],$={property:p,perValue:{}},_=new Set;for(let I=0;I<f;I++){let y=u[I],T=await getNested(y,p);if(void 0===T)continue;let S="boolean"!=typeof T?T:""+T;void 0===$.perValue[S]&&($.perValue[S]={indexes:[],count:0}),!($.perValue[S].count>=d)&&($.perValue[S].indexes.push(I),$.perValue[S].count++,_.add(T))}h.push(Array.from(_)),g[p]=$}let D=calculateCombination(h),b=D.length,E=[];for(let P=0;P<b;P++){let A=D[P],N=A.length,w={values:[],indexes:[]},O=[];for(let k=0;k<N;k++){let R=A[k],L=n[k];O.push(g[L].perValue["boolean"!=typeof R?R:""+R].indexes),w.values.push(R)}w.indexes=intersect(O).sort((e,t)=>e-t),0!==w.indexes.length&&E.push(w)}let x=E.length,U=Array.from({length:x});for(let M=0;M<x;M++){let z=E[M],B=r.reduce||DEFAULT_REDUCE,F=z.indexes.map(e=>({id:l[e],score:t[e][1],document:u[e]})),W=B.reducer.bind(null,z.values),G=B.getInitialValue(z.indexes.length),Y=F.reduce(W,G);U[M]={values:z.values,result:Y}}return U}function calculateCombination(e,t=0){if(t+1===e.length)return e[t].map(e=>[e]);let r=e[t],n=calculateCombination(e,t+1),o=[];for(let i of r)for(let a of n){let s=[i];safeArrayPush(s,a),o.push(s)}return o}let defaultBM25Params={k:1.2,b:.75,d:.5};async function createSearchContext(e,t,r,n,o,i,a,s,l){let u={},f={};for(let d of i){let h={};for(let g of a)h[g]=[];u[d]=h,f[d]=[]}return{timeStart:l,tokenizer:e,index:t,documentsStore:r,language:n,params:o,docsCount:s,uniqueDocsIDs:{},indexMap:u,docsIntersection:f}}async function search1(e,t,r){let n=await getNanosecondsTime();t.relevance=Object.assign(t.relevance??{},defaultBM25Params);let o=t.facets&&Object.keys(t.facets).length>0,{limit:i=10,offset:a=0,term:s,properties:l,threshold:u=1,distinctOn:f}=t,d=!0===t.preflight,{index:h,docs:g}=e.data,m=await e.tokenizer.tokenize(s??"",r),p=e.caches.propertiesToSearch;if(!p){let $=await e.index.getSearchablePropertiesWithTypes(h);p=(p=await e.index.getSearchableProperties(h)).filter(e=>$[e].startsWith("string")),e.caches.propertiesToSearch=p}if(l&&"*"!==l){for(let _ of l)if(!p.includes(_))throw createError("UNKNOWN_INDEX",_,p.join(", "));p=p.filter(e=>l.includes(e))}let I=await createSearchContext(e.tokenizer,e.index,e.documentsStore,r,t,p,m,await e.documentsStore.count(g),n),y=Object.keys(t.where??{}).length>0,T=[];y&&(T=await e.index.searchByWhereClause(I,h,t.where));let S=m.length;if(S||l&&l.length>0){let D=p.length;for(let b=0;b<D;b++){var E;let P=p[b];if(0!==S)for(let A=0;A<S;A++){let N=m[A],w=await e.index.search(I,h,P,N);safeArrayPush(I.indexMap[P][N],w)}else{I.indexMap[P][""]=[];let O=await e.index.search(I,h,P,"");safeArrayPush(I.indexMap[P][""],O)}let k=I.indexMap[P],R=Object.values(k);I.docsIntersection[P]=prioritizeTokenScores(R,(null==t?void 0:null===(E=t.boost)||void 0===E?void 0:E[P])??1,u,S);let L=I.docsIntersection[P],x=L.length;for(let U=0;U<x;U++){let[M,z]=L[U],B=I.uniqueDocsIDs[M];B?I.uniqueDocsIDs[M]=B+z+.5:I.uniqueDocsIDs[M]=z}}}else 0===m.length&&s?I.uniqueDocsIDs={}:I.uniqueDocsIDs=Object.fromEntries(Object.keys(await e.documentsStore.getAll(e.data.docs)).map(e=>[e,0]));let F=Object.entries(I.uniqueDocsIDs).map(([e,t])=>[+e,t]);if(y&&(F=intersectFilteredIDs(T,F)),t.sortBy){if("function"==typeof t.sortBy){let W=F.map(([e])=>e),G=await e.documentsStore.getMultiple(e.data.docs,W),Y=G.map((e,t)=>[F[t][0],F[t][1],e]);Y.sort(t.sortBy),F=Y.map(([e,t])=>[e,t])}else F=await e.sorter.sortBy(e.data.sorting,F,t.sortBy).then(t=>t.map(([t,r])=>[getInternalDocumentId(e.internalDocumentIDStore,t),r]))}else F=F.sort(sortTokenScorePredicate);let H;!d&&f?H=await fetchDocumentsWithDistinct(e,F,a,i,f):d||(H=await fetchDocuments(e,F,a,i));let q={elapsed:{formatted:"",raw:0},hits:[],count:F.length};if(void 0!==H&&(q.hits=H.filter(Boolean)),o){let K=await getFacets(e,F,t.facets);q.facets=K}return t.groupBy&&(q.groups=await getGroups(e,F,t.groupBy)),e.afterSearch&&await runAfterSearch(e.afterSearch,e,t,r,q),q.elapsed=await e.formatElapsedTime(await getNanosecondsTime()-I.timeStart),q}async function fetchDocumentsWithDistinct(e,t,r,n,o){let i=e.data.docs,a=new Map,s=[],l=new Set,u=t.length,f=0;for(let d=0;d<u;d++){let h=t[d];if(void 0===h)continue;let[g,m]=h;if(l.has(g))continue;let p=await e.documentsStore.get(i,g),$=await getNested(p,o);if(!(void 0===$||a.has($))){if(a.set($,!0),!(++f<=r)&&(s.push({id:getDocumentIdFromInternalId(e.internalDocumentIDStore,g),score:m,document:p}),l.add(g),f>=r+n))break}}return s}async function fetchDocuments(e,t,r,n){let o=e.data.docs,i=Array.from({length:n}),a=new Set;for(let s=r;s<n+r;s++){let l=t[s];if(void 0===l)break;let[u,f]=l;if(!a.has(u)){let d=await e.documentsStore.get(o,u);i[s]={id:getDocumentIdFromInternalId(e.internalDocumentIDStore,u),score:f,document:d},a.add(u)}}return i}export{kInsertions as kInsertions,kRemovals as kRemovals,create7 as create,insertMultiple as insertMultiple,search1 as search};